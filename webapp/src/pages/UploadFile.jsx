import React, { useState } from 'react'
import { Container, Typography, Box, CircularProgress, Card, Tab, Tabs, Grid } from '@mui/material';
import { DoneAllOutlined, UploadFileOutlined } from '@mui/icons-material';
import Button from '@mui/material/Button';
import InfoOutlinedIcon from '@mui/icons-material/InfoOutlined';
import CheckCircleOutlineIcon from '@mui/icons-material/CheckCircleOutline';
import VisibilityOffIcon from '@mui/icons-material/VisibilityOff';
import '../UploadFile.css'
import { malwareScan } from '../service';
import CircularProgressWithLabel from '../components/progress/Progress';
function TabPanel(props) {
    const { children, value, index, ...other } = props;
    return (
        <div
            role="tabpanel"
            hidden={value !== index}
            id={`simple-tabpanel-${index}`}
            aria-labelledby={`simple-tab-${index}`}
            {...other}
        >
            {value === index && (
                <Box sx={{ p: 3 }}>
                    <Typography>{children}</Typography>
                </Box>
            )}
        </div>
    );
}

function a11yProps(index) {
    return {
        id: `simple-tab-${index}`,
        'aria-controls': `simple-tabpanel-${index}`,
    };
}

export default function UploadFile() {
    const [dragging, setDragging] = useState(false);
    const [file, setFile] = useState(null);
    const [isApiCallSuccess, setIsApiCallSuccess] = useState(false);

    const [error, setError] = React.useState("")
    const [loading, setLoading] = React.useState(false)
    const [message, setMessage] = React.useState("")

    const [scanData, setScanData] = useState([])
    const [value, setValue] = React.useState(0);

    const handleChange = (event, newValue) => {
        setValue(newValue);
    };

    function handleDragEnter(event) {
        event.preventDefault();
        setDragging(true);
    }

    function handleDragLeave(event) {
        event.preventDefault();
        setDragging(false);
    }

    function handleDrop(event) {
        event.preventDefault();
        setDragging(false);
        const files = event.dataTransfer.files;
        handleFiles(files);
    }

    function handleInputChange(event) {
        const files = event.target.files;
        handleFiles(files);
    }

    function handleFiles(files) {
        if (files.length === 0) {
            return;
        }
        const file = files[0];
        setFile(file);
    }

    function handleFormSubmit(event) {
        event.preventDefault();
        if (!file) {
            alert('Please select a file to upload');
            return;
        }
        setMessage("")
        setLoading(true)
        const formData = new FormData();
        formData.append('file', file);
        malwareScan(formData).then(res => {
            setLoading(false)
            setMessage("Upload file successfully!")
            setScanData(res.data)
            setIsApiCallSuccess(true)
        }).catch(err => {
            setLoading(false)
            setIsApiCallSuccess(false)
            setError(err.message)
            console.error(err)
        })
    }
    return (
        <>
            <Container maxWidth="xl">
                <div
                    className={`dropzone ${dragging ? 'dragging' : ''}`}
                    onDragEnter={handleDragEnter}
                    onDragLeave={handleDragLeave}
                    onDragOver={event => event.preventDefault()}
                    onDrop={handleDrop}
                >
                    <UploadFileOutlined sx={{ fontSize: "70px" }} />
                    <Typography>
                        Drag & Drop to Upload File
                    </Typography>

                    <Typography>
                        OR
                    </Typography>
                    <form onSubmit={handleFormSubmit}>
                        <input
                            type="file"
                            id="file"
                            className="custom-file-input "
                            onChange={handleInputChange}
                        />
                        <Typography variant='body1' fontWeight={700} sx={{ p: 2 }}>{file && file.name}</Typography>
                        <Button variant="contained" type="submit" disabled={file === null ? true : false}>
                            {loading ? <CircularProgress size={"20px"} color="inherit" /> : 'Upload'}
                        </Button>
                    </form>
                    <Typography color={'green'} fontSize={"12px"}>
                        {message}
                    </Typography>
                    <Typography color={"red"} fontSize={"12px"}>
                        {error}
                    </Typography>
                </div>
                <Box sx={{ mt: 2 }}>
                    <Card>
                        {(false && message!=="") ? (
                            <Box sx={{ width: '100%' }}>
                                <Box sx={{ borderBottom: 1, borderColor: 'divider' }}>
                                    <Tabs value={value} onChange={handleChange} aria-label="basic tabs example">
                                        <Tab label="Detection" {...a11yProps(0)} />
                                        <Tab label="Details" {...a11yProps(1)} />
                                    </Tabs>
                                </Box>
                                <TabPanel value={value} index={0}>
                                    {
                                        (isApiCallSuccess &&  scanData.hasOwnProperty('report')) &&
                                        <Box sx={{width:"100%",display:"flex", minHeight:"100px"}}>

                                           <Box sx={{width:"100%",display:"flex",border:"1px dashed #ccc",p:5}}>
                                           <Box sx={{width:"20%",display:"flex"}} >
                                           <CircularProgressWithLabel 
                                            value={Object.keys(scanData?.report?.data?.attributes?.last_analysis_results)
                                                ?.filter((item) => scanData?.report?.data?.attributes?.last_analysis_results[item].category === "malicious").length}
                                                total={Object.keys(scanData?.report?.data?.attributes?.last_analysis_results).length} />
                                           </Box>
                                           <Typography color="#d32f2f" sx={{width:"80%",display: "flex", alignItems:"center"}}>
                                                <InfoOutlinedIcon color='error'/>
                                                {Object.keys(scanData?.report?.data?.attributes?.last_analysis_results)
                                                ?.filter((item) => scanData?.report?.data?.attributes?.last_analysis_results[item].category === "malicious").length} security vendors and no sandboxes flagged this file as malicious
                                            </Typography>
                                           </Box>
                                        </Box>
                                    }
                                    <Box sx={{ flexGrow: 1,mt:2 }}>
                                        <Grid container spacing={2} columns={16}>
                                            {(isApiCallSuccess && scanData.hasOwnProperty('report')) &&
                                                Object.keys(scanData?.report?.data?.attributes?.last_analysis_results)
                                                    ?.filter((item) => scanData?.report?.data?.attributes?.last_analysis_results[item].category === "malicious")
                                                    ?.map((item, index) => {
                                                        return (<>
                                                            <Grid item xs={8} sx={{ textAlign: "left", display: "flex" }} key={index}>
                                                                <Grid container columns={16}>
                                                                    <Grid item xs={8}>
                                                                        <Typography>
                                                                            {item}
                                                                        </Typography>
                                                                    </Grid>
                                                                    <Grid item xs={8}>
                                                                        <Typography sx={{ display: "flex", alignItems: "center" }} color="#d32f2f" fontSize={"12px"}>
                                                                            <InfoOutlinedIcon color='error' />
                                                                            {scanData?.report?.data?.attributes?.last_analysis_results[item].result}
                                                                        </Typography>
                                                                    </Grid>
                                                                </Grid>
                                                            </Grid>
                                                        </>)
                                                    })}
                                        </Grid>
                                    </Box>
                                    <Box sx={{ flexGrow: 1, mt: 2 }}>
                                        <Grid container spacing={2} columns={16}>
                                            {(isApiCallSuccess && scanData.hasOwnProperty('report')) &&
                                                Object.keys(scanData?.report?.data?.attributes?.last_analysis_results)
                                                    ?.filter((item) => scanData?.report?.data?.attributes?.last_analysis_results[item].category === "undetected")
                                                    ?.map((item, index) => {
                                                        return (<>
                                                            <Grid item xs={8} sx={{ textAlign: "left", display: "flex" }} key={index}>
                                                                <Grid container columns={16}>
                                                                    <Grid item xs={8}>
                                                                        <Typography>
                                                                            {item}
                                                                        </Typography>
                                                                    </Grid>
                                                                    <Grid item xs={8}>
                                                                        <Typography sx={{ display: "flex", alignItems: "center" }} fontSize={"12px"}>
                                                                            <CheckCircleOutlineIcon color='success' /> Undetected
                                                                            {scanData?.report?.data?.attributes?.last_analysis_results[item].result}
                                                                        </Typography>
                                                                    </Grid>
                                                                </Grid>
                                                            </Grid>
                                                        </>)
                                                    })}
                                        </Grid>
                                    </Box>

                                    <Box sx={{ flexGrow: 1, mt: 2 }}>
                                        <Grid container spacing={2} columns={16}>
                                            {(isApiCallSuccess && scanData.hasOwnProperty('report')) &&
                                                Object.keys(scanData?.report?.data?.attributes?.last_analysis_results)
                                                    ?.filter((item) => scanData?.report?.data?.attributes?.last_analysis_results[item].category === "type-unsupported")
                                                    ?.map((item, index) => {
                                                        return (<>
                                                            <Grid item xs={8} sx={{ textAlign: "left", display: "flex" }} key={index}>
                                                                <Grid container columns={16}>
                                                                    <Grid item xs={8}>
                                                                        <Typography>
                                                                            {item}
                                                                        </Typography>
                                                                    </Grid>
                                                                    <Grid item xs={8}>
                                                                        <Typography sx={{ display: "flex", alignItems: "center" }} color={"darkgrey"} fontSize={"12px"}>
                                                                            <VisibilityOffIcon color="disabled" />   to process this file type
                                                                            {scanData?.report?.data?.attributes?.last_analysis_results[item].result}
                                                                        </Typography>
                                                                    </Grid>
                                                                </Grid>
                                                            </Grid>
                                                        </>)
                                                    })}
                                        </Grid>
                                    </Box>
                                </TabPanel>
                                <TabPanel value={value} index={1}>

                                </TabPanel>
                            </Box>
                        ) : ""}
                    </Card>
                </Box>
            </Container>
        </>
    )
}
