var express = require("express");
const crypto = require("crypto");
const fs = require("fs");
const multer = require("multer");
const axios = require("axios").default;
var router = express.Router();
const Malware = require('../models/malware');

const storage = multer.diskStorage({
  destination: (req, file, callback) => {
    callback(null, "uploads");
  },
  filename: (req, file, callback) => {
    callback(null, file.originalname);
  },
});

const upload = multer();
router.post("/", upload.single("file"), async function (req, res, next) {
  const hashSum = crypto.createHash("sha256");
  hashSum.update(req.file.buffer);
  const hex = hashSum.digest("hex");
  let isMalwareFileExists = await Malware.findOne({ hash: hex });

  const formData = new FormData();
  const blob = new Blob([req.file], { type: req.file.mimetype });
  formData.append("file", blob, { filename: req.file.originalname });

  if (!isMalwareFileExists) {
    axios
      .post(`https://www.virustotal.com/api/v3/files`, formData, {
        headers: {
          "x-apikey": process.env.V_TOKEN,
          "Content-Type": "multipart/form-data",
        },
      })
      .then((re) => {
        axios
          .get(
            `https://www.virustotal.com/api/v3/analyses/${re.data?.data?.id}`,
            {
              headers: {
                "x-apikey": process.env.V_TOKEN,
              },
            }
          )
          .then(async (analyses) => {

            const newMalware = {
              name: req.file.originalname + Date.now(),
              hash: hex,
              url: "https://malwarepro.ams3.digitaloceanspaces.com/malwarepro/" + req.file.originalname,
              status: analyses?.data?.data?.attributes?.status || "status_not_exists"
            };

            let malwareResult = await Malware.create(newMalware);
            console.log(malwareResult);
            res
              .json({
                message: "file upload successfully!",
                report: analyses.data,
              })
              .status(200);
          })
          .catch((err) => {
            console.error(err);
            res.json({ message: err.message }).status(500);
          });
      })
      .catch((err) => {
        console.error(err);
        res
          .json({ message: err.message, stack: JSON.stringify(err.stack) })
          .status(500);
      });
  } else {
    axios
      .get(`https://www.virustotal.com/api/v3/files/${hex}`, {
        headers: {
          "x-apikey": process.env.V_TOKEN,
        },
      })
      .then((obj) => {
        res
          .json({
            message: "File Exists!!",
            report: obj.data,
          })
          .status(200);
      })
      .catch((err) => {
        console.error(err);
        res
          .json({ message: err.message, stack: JSON.stringify(err.stack) })
          .status(500);
      });
  }
});
router.get("/", async function (req, res, next) {
  let malwareResult = await Malware.find({});
  res.json({ data: malwareResult });
});
router.get("/:hex", async function (req, res, next) {
  axios
    .get(`https://www.virustotal.com/api/v3/files/${req.params.hex}`, {
      headers: {
        "x-apikey": process.env.V_TOKEN,
      },
    })
    .then((obj) => {
      res
        .json({
          report: obj.data,
        })
        .status(200);
    })
    .catch((err) => {
      console.error(err);
      res
        .json({ message: err.message, stack: JSON.stringify(err.stack) })
        .status(500);
    });
});
module.exports = router;
