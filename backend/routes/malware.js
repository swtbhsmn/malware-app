var express = require("express");
const crypto = require("crypto");
const fs = require("fs");
const multer = require("multer");
const multerS3 = require("multer-s3");
const {
  S3Client,
  PutObjectCommand,
  ListBucketsCommand,
  List,
} = require("@aws-sdk/client-s3");
const axios = require("axios").default;
var router = express.Router();
const Malware = require('../models/malware');
// const client = new S3Client({
//   region: "us-east-1",
//   credentials: {
//     accessKeyId: "DO00YHGZEDQBF3F7H3GL",
//     secretAccessKey: "BPpPLejPpxzztEfn8SKwdaCp/DYGn61sBeprIXhW6lM",
//   },
// });

const storage = multer.diskStorage({
  destination: (req, file, callback) => {
    callback(null, "uploads");
  },
  filename: (req, file, callback) => {
    callback(null, file.originalname);
  },
});

const upload = multer();
router.post("/", upload.single("file"), async function (req, res, next) {
  const hashSum = crypto.createHash("sha256");
  hashSum.update(req.file.buffer);
  const hex = hashSum.digest("hex");
  await Malware.findOne({ hex: hex }, function (err, malware) {
    if (err) {
      console.log(err);
    } else {
      console.log(malware);
    }
  });
  const formData = new FormData();
  const blob = new Blob([req.file], { type: req.file.mimetype });
  formData.append("file", blob, { filename: req.file.originalname });

  const params = {
    Bucket: "malwarepro",
    Key: "/files",
    Body: req.file,
  };
  axios
    .get(`https://www.virustotal.com/api/v3/files/${hex}`, {
      headers: {
        "x-apikey": process.env.V_TOKEN,
      },
    })
    .then((result) => {
      res
        .json({
          message: "file upload successfully!",
          report: result.data,
        })
        .status(200);
    })
    .catch((err) => {
      console.error(err);
      res
        .json({ message: err.message, stack: JSON.stringify(err.stack) })
        .status(500);
    });


  // axios
  //   .post(`https://www.virustotal.com/api/v3/files`, formData, {
  //     headers: {
  //       "x-apikey": process.env.V_TOKEN,
  //       "Content-Type": "multipart/form-data",
  //     },
  //   })
  //   .then((result) => {
  //     axios
  //       .get(
  //         `https://www.virustotal.com/api/v3/analyses/${result.data?.data?.id}`,
  //         {
  //           headers: {
  //             "x-apikey": process.env.V_TOKEN,
  //           },
  //         }
  //       )
  //       .then((analyses) => {
  //         const command = new PutObjectCommand(params);
  //         // client
  //         //   .send(command)
  //         //   .then((data) => {
  //         //     console.log("File uploaded successfully:", data);
  //         //   })
  //         //   .catch((error) => {
  //         //     console.error("Error uploading file:", error);
  //         //   });
  //         res
  //           .json({
  //             message: "file upload successfully!",
  //             analyses: analyses.data,
  //           })
  //           .status(200);
  //       })
  //       .catch((err) => {
  //         console.error(err);
  //         res.json({ message: err.message }).status(500);
  //       });
  //   })
  //   .catch((err) => {
  //     console.error(err);
  //     res
  //       .json({ message: err.message, stack: JSON.stringify(err.stack) })
  //       .status(500);
  //   });
});
module.exports = router;
